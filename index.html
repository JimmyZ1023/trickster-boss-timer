<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚å…‰å¡å·´æ‹‰å³¶ Boss & å¤œæ™šè¨ˆæ™‚å™¨</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â°</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Quicksand', 'sans-serif'],
                    },
                    colors: {
                        'lofi-bg': '#FDFCF6',
                        'lofi-sidebar': '#F2EFE5',
                        'lofi-purple': '#B5A0D9',
                        'lofi-text': '#4A4A4A',
                        'discord': '#5865F2',
                        'night-bg': '#1e293b', // Dark blue for night
                        'night-accent': '#fbbf24' // Moon yellow
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FDFCF6; color: #4A4A4A; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F2EFE5; }
        ::-webkit-scrollbar-thumb { background: #D1C7B7; border-radius: 4px; }
        .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .btn-hover:hover { transform: translateY(-2px); filter: brightness(1.05); }
        .btn-hover:active { transform: translateY(0); }
        
        /* Night Mode Animations */
        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .star-icon { animation: twinkle 2s infinite ease-in-out; }
        
        @keyframes flash {
            0% { background-color: #fee2e2; }
            50% { background-color: #fca5a5; }
            100% { background-color: #fee2e2; }
        }
        .time-up-bg { animation: flash 1s infinite; }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden selection:bg-lofi-purple selection:text-white">

    <aside class="w-64 bg-lofi-sidebar border-r-2 border-white flex flex-col shadow-sm z-10">
        <div class="p-6 border-b border-gray-200/50">
            <h1 class="text-xl font-bold text-lofi-text tracking-tight">
                <i class="fa-solid fa-clock text-lofi-purple mr-2"></i>æ™‚å…‰å¡å·´æ‹‰å³¶å°ˆç”¨
            </h1>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="accountList"></div>
        <div class="p-4 border-t border-gray-200/50">
            <button onclick="createNewAccount()" class="w-full py-3 bg-white border-2 border-lofi-purple text-lofi-purple font-bold rounded-2xl btn-hover shadow-sm flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> æ–°å¢å¸³è™Ÿ
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <header class="p-6 bg-white/50 backdrop-blur-md sticky top-0 z-10 border-b border-gray-100 flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold" id="currentAccountTitle">è«‹é¸æ“‡å¸³è™Ÿ</h2>
                <p class="text-sm text-gray-400">é¸æ“‡ Boss æˆ–ç³»çµ±é¬§é˜</p>
            </div>
            <div class="flex gap-3">
                <select id="bossSelect" class="px-4 py-2 rounded-xl border-2 border-gray-200 bg-white focus:outline-none focus:border-lofi-purple text-lofi-text font-semibold">
                    </select>
                <button onclick="addTimerToCurrentAccount()" class="px-6 py-2 bg-lofi-purple text-white rounded-xl font-bold shadow-md btn-hover">
                    åŠ å…¥æ¸…å–®
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div id="timersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            
            <div id="emptyState" class="hidden h-full flex flex-col items-center justify-center text-gray-300">
                <i class="fa-regular fa-compass text-6xl mb-4"></i>
                <p class="text-lg">é‚„æ²’æœ‰è¨ˆæ™‚å™¨ï¼Œå¾ä¸Šæ–¹æ–°å¢ä¸€å€‹å§ï¼</p>
            </div>
        </div>

        <footer class="p-4 bg-white border-t border-gray-100 flex justify-center items-center gap-2">
            <span class="text-gray-500 font-medium">é‚„æ²’åŠ å…¥ç¤¾ç¾¤å—ï¼Ÿ</span>
            <a href="https://discord.gg/M7CZFccuS2" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-discord text-white rounded-full font-bold text-sm btn-hover shadow-lg hover:shadow-discord/50 transition-all">
                <i class="fa-brands fa-discord"></i>
                åŠ å…¥æ™‚å…‰å¡å·´æ‹‰å³¶ç¤¾ç¾¤ (Discord)
            </a>
        </footer>
    </main>

    <script>
        // --- Data ---
        // type: 'normal' is for boss, 'night_cycle' is for the special night clock
        const BOSS_DATA = [
            { name: "å¤œæ™šåˆ°ä¾†é¬§é˜ (æ¯å°æ™‚å¾ªç’°)", minutes: 0, type: 'night_cycle' },
            { name: "æ³•è€è­·è¡›", minutes: 20, type: 'normal',image: './Tutankhamen.gif' },
            { name: "å¤å¢“å®ˆè¡›", minutes: 20, type: 'normal' },
            { name: "å¹½éˆèˆ¹é•·å²åº«çˆ¾", minutes: 20, type: 'normal' },
            { name: "æµ·è³Šç‹å¡è˜­", minutes: 30, type: 'normal' },
            { name: "å¤©é”ç…å­", minutes: 30, type: 'normal' },
            { name: "å†°ä¹‹å¥³ç‹å¥§è¿ªå¨œ", minutes: 45, type: 'normal' },
            { name: "ç´¢å¥‡", minutes: 45, type: 'normal' }
        ];

        let appData = { accounts: [], activeAccountId: null };

        // --- Init ---
        function init() {
            loadData();
            const select = document.getElementById('bossSelect');
            BOSS_DATA.forEach(boss => {
                const opt = document.createElement('option');
                opt.value = boss.minutes;
                // Distinguish label for clarity
                opt.text = boss.type === 'night_cycle' ? `ğŸŒ™ ${boss.name}` : `${boss.name} (${boss.minutes}åˆ†é˜)`;
                opt.dataset.name = boss.name;
                opt.dataset.type = boss.type;
                select.appendChild(opt);
            });

            if (appData.accounts.length === 0) createNewAccount("ç¥ä½ å‡ºå‚³èªª");
            else {
                if (!appData.activeAccountId) appData.activeAccountId = appData.accounts[0].id;
                renderAccounts();
                renderTimers();
            }
            
            // Fast tick for smoother UI, but logic runs per second
            setInterval(tick, 1000);
        }

        // --- Persistence ---
        function saveData() { localStorage.setItem('caballaTimerDataV2', JSON.stringify(appData)); }
        function loadData() {
            const saved = localStorage.getItem('caballaTimerDataV2');
            if (saved) appData = JSON.parse(saved);
        }

        // --- Account ---
        function createNewAccount(name = null) {
            const newName = name || prompt("è«‹è¼¸å…¥æ–°å¸³è™Ÿåç¨±ï¼š", "æ–°å³¶æ°‘");
            if (!newName) return;
            const newAccount = { id: Date.now(), name: newName, timers: [] };
            appData.accounts.push(newAccount);
            appData.activeAccountId = newAccount.id;
            saveData(); renderAccounts(); renderTimers();
        }
        function switchAccount(id) { appData.activeAccountId = id; saveData(); renderAccounts(); renderTimers(); }
        function deleteAccount(id, e) {
            e.stopPropagation();
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹å¸³è™ŸåŠå…¶æ‰€æœ‰è¨ˆæ™‚å™¨å—ï¼Ÿ")) {
                appData.accounts = appData.accounts.filter(acc => acc.id !== id);
                appData.activeAccountId = appData.accounts.length > 0 ? appData.accounts[0].id : null;
                saveData(); renderAccounts(); renderTimers();
            }
        }
        function renameAccount(id, e) {
            e.stopPropagation();
            const account = appData.accounts.find(acc => acc.id === id);
            const newName = prompt("æ›´åå¸³è™Ÿï¼š", account.name);
            if (newName) { account.name = newName; saveData(); renderAccounts(); }
        }

        // --- Logic ---
        function addTimerToCurrentAccount() {
            if (!appData.activeAccountId) return alert("è«‹å…ˆå»ºç«‹æˆ–é¸æ“‡ä¸€å€‹å¸³è™Ÿï¼");
            
            const select = document.getElementById('bossSelect');
            const selectedOpt = select.options[select.selectedIndex];
            const bossName = selectedOpt.dataset.name;
            const type = selectedOpt.dataset.type;
            const minutes = parseInt(select.value);

            const account = appData.accounts.find(acc => acc.id === appData.activeAccountId);
            
            // Prevent duplicates for Night Cycle in the same account
            if (type === 'night_cycle' && account.timers.some(t => t.type === 'night_cycle')) {
                return alert("é€™å€‹å¸³è™Ÿå·²ç¶“æœ‰å¤œæ™šé¬§é˜å›‰ï¼");
            }

            const newTimer = {
                id: Date.now() + Math.random(),
                name: bossName,
                type: type, // 'normal' or 'night_cycle'
                totalSeconds: minutes * 60,
                remainingSeconds: minutes * 60,
                status: type === 'night_cycle' ? 'running' : 'idle', // Night clock auto-starts
                lastTick: Date.now(),
                // Special fields for night clock
                isNight: false,
                nightLabel: '' 
            };

            account.timers.push(newTimer);
            saveData(); renderTimers();
        }

        function controlTimer(timerId, action) {
            const account = appData.accounts.find(acc => acc.id === appData.activeAccountId);
            const timer = account.timers.find(t => t.id === timerId);
            
            if (action === 'delete') {
                account.timers = account.timers.filter(t => t.id !== timerId);
            } else if (timer.type === 'normal') {
                // Only normal timers accept start/pause/reset
                if (action === 'start') {
                    timer.status = 'running';
                    timer.lastTick = Date.now();
                } else if (action === 'pause') {
                    timer.status = 'paused';
                } else if (action === 'reset') {
                    timer.status = 'idle';
                    timer.remainingSeconds = timer.totalSeconds;
                }
            }
            saveData(); renderTimers();
        }

        function tick() {
            const now = Date.now();
            const dateObj = new Date();
            const currentMin = dateObj.getMinutes();
            const currentSec = dateObj.getSeconds();
            
            let needsRender = false;

            appData.accounts.forEach(acc => {
                acc.timers.forEach(timer => {
                    // Logic for Night Cycle Clock
                    if (timer.type === 'night_cycle') {
                        // Night is 43:00 to 53:00 (exclusive of 53:00 for calculation start)
                        // Range: 43 <= min < 53
                        const isNightNow = (currentMin >= 43 && currentMin < 53);
                        timer.isNight = isNightNow;
                        timer.status = 'running'; // Always running

                        if (isNightNow) {
                            // Counting down to 53:00 (Day start)
                            // Target: Current Hour:53:00
                            const targetMin = 53;
                            const diffMins = targetMin - 1 - currentMin; // -1 because we count seconds too
                            const diffSecs = 60 - currentSec;
                            timer.remainingSeconds = (diffMins * 60) + diffSecs;
                            timer.totalSeconds = 10 * 60; // Night lasts 10 mins
                            timer.nightLabel = "è·é›¢ç™½å¤©";
                        } else {
                            // Counting down to 43:00 (Night start)
                            let targetMin = 43;
                            let minOffset = 0;
                            
                            if (currentMin >= 53) {
                                // Waiting for next hour's 43
                                minOffset = (60 - currentMin) + 43 - 1; 
                            } else {
                                // Waiting for this hour's 43 (currentMin < 43)
                                minOffset = 43 - 1 - currentMin;
                            }
                            
                            const diffSecs = 60 - currentSec;
                            timer.remainingSeconds = (minOffset * 60) + diffSecs;
                            timer.totalSeconds = 50 * 60; // Day lasts 50 mins
                            timer.nightLabel = "è·é›¢å¤œæ™š";
                        }
                        // Always update render for system clock
                        if (acc.id === appData.activeAccountId) needsRender = true;
                    } 
                    // Logic for Normal Boss Timer
                    else if (timer.status === 'running') {
                        const delta = Math.floor((now - timer.lastTick) / 1000);
                        if (delta >= 1) {
                            timer.remainingSeconds -= delta;
                            timer.lastTick = now;
                            if (timer.remainingSeconds <= 0) {
                                timer.remainingSeconds = 0;
                                timer.status = 'finished';
                            }
                            if (acc.id === appData.activeAccountId) needsRender = true;
                        }
                    }
                });
            });

            if (needsRender) {
                renderTimers();
                // saveData(); // Optional: Don't save every second to avoid performance hit, rely on manual actions or periodic save
            }
        }

        // --- Render ---
        function renderAccounts() {
            const list = document.getElementById('accountList');
            list.innerHTML = '';
            appData.accounts.forEach(acc => {
                const isActive = acc.id === appData.activeAccountId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${isActive ? 'bg-white shadow-md border-l-4 border-lofi-purple' : 'hover:bg-white/60'}`;
                div.onclick = () => switchAccount(acc.id);
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center text-lofi-purple font-bold text-xs shrink-0">${acc.name.substring(0, 1)}</div>
                        <span class="font-bold text-sm truncate ${isActive ? 'text-lofi-text' : 'text-gray-500'}">${acc.name}</span>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="renameAccount(${acc.id}, event)" class="p-1.5 text-gray-400 hover:text-lofi-purple rounded-md hover:bg-gray-100"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteAccount(${acc.id}, event)" class="p-1.5 text-gray-400 hover:text-red-400 rounded-md hover:bg-gray-100"><i class="fa-solid fa-trash"></i></button>
                    </div>`;
                list.appendChild(div);
            });
            const currentAcc = appData.accounts.find(a => a.id === appData.activeAccountId);
            document.getElementById('currentAccountTitle').innerText = currentAcc ? currentAcc.name : "ç„¡å¸³è™Ÿ";
        }

        function renderTimers() {
            function renderTimers() {
            const container = document.getElementById('timersContainer');
            const emptyState = document.getElementById('emptyState');
            container.innerHTML = '';

            const account = appData.accounts.find(acc => acc.id === appData.activeAccountId);
            if (!account || account.timers.length === 0) {
                emptyState.classList.remove('hidden'); return;
            }
            emptyState.classList.add('hidden');

            account.timers.forEach(timer => {
                const radius = 56;
                const circumference = 2 * Math.PI * radius;
                
                // â–¼â–¼â–¼ æ–°å¢ï¼šå°‹æ‰¾åœ–ç‰‡çš„é‚è¼¯ â–¼â–¼â–¼
                const bossInfo = BOSS_DATA.find(b => b.name === timer.name);
                // å¦‚æœæ‰¾ä¸åˆ°åœ–ç‰‡ï¼Œå°±ç”¨é è¨­çš„å•è™Ÿåœ–
                const imageUrl = (bossInfo && bossInfo.image) ? bossInfo.image : 'https://cdn-icons-png.flaticon.com/512/5726/5726678.png';
                // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

                let strokeColor = 'text-lofi-purple';
                let cardBg = 'bg-white';
                let statusText = '';
                let progress = 0;
                let showControls = true;
                
                // --- STYLE LOGIC ---
                if (timer.type === 'night_cycle') {
                    showControls = false;
                    progress = timer.totalSeconds > 0 ? (timer.remainingSeconds / timer.totalSeconds) : 0;
                    
                    if (timer.isNight) {
                        cardBg = 'bg-slate-800 text-white border-slate-700 shadow-xl shadow-indigo-500/20';
                        strokeColor = 'text-night-accent';
                        statusText = 'âœ¨ å¤œæ™šä¸­ âœ¨';
                    } else {
                        cardBg = 'bg-sky-50 text-slate-700 border-sky-100';
                        strokeColor = 'text-sky-400';
                        statusText = 'â˜€ï¸ ç™½å¤©';
                    }
                } else {
                    progress = timer.totalSeconds > 0 ? (timer.remainingSeconds / timer.totalSeconds) : 0;
                    if (timer.status === 'finished') {
                        strokeColor = 'text-red-400'; cardBg = 'bg-red-50 time-up-bg'; statusText = 'BOSS å‡ºç¾!';
                    } else if (timer.status === 'running') statusText = 'å€’æ•¸ä¸­...';
                    else if (timer.status === 'paused') { strokeColor = 'text-gray-300'; statusText = 'å·²æš«åœ'; }
                    else statusText = 'æº–å‚™é–‹å§‹';
                }

                const dashoffset = circumference - (progress * circumference);
                const mins = Math.floor(timer.remainingSeconds / 60).toString().padStart(2, '0');
                const secs = Math.floor(timer.remainingSeconds % 60).toString().padStart(2, '0');

                const card = document.createElement('div');
                card.className = `${cardBg} rounded-3xl p-6 shadow-sm border border-gray-100 flex flex-col items-center gap-4 relative transition-all duration-500`;
                
                let controlsHtml = '';
                if (showControls) {
                    controlsHtml = `
                        <div class="flex gap-2 w-full justify-center mt-2">
                            ${timer.status === 'running' 
                                ? `<button onclick="controlTimer(${timer.id}, 'pause')" class="flex-1 py-2 rounded-xl bg-orange-100 text-orange-600 font-bold hover:bg-orange-200 btn-hover"><i class="fa-solid fa-pause"></i> æš«åœ</button>`
                                : `<button onclick="controlTimer(${timer.id}, 'start')" class="flex-1 py-2 rounded-xl bg-green-100 text-green-600 font-bold hover:bg-green-200 btn-hover" ${timer.status === 'finished' ? 'disabled class="opacity-50 cursor-not-allowed"' : ''}><i class="fa-solid fa-play"></i> é–‹å§‹</button>`
                            }
                            <button onclick="controlTimer(${timer.id}, 'reset')" class="px-4 py-2 rounded-xl bg-gray-100 text-gray-500 font-bold hover:bg-gray-200 btn-hover"><i class="fa-solid fa-rotate-right"></i></button>
                        </div>
                    `;
                } else {
                    controlsHtml = `
                        <div class="mt-2 text-center text-sm font-medium opacity-80">
                            ${timer.nightLabel}
                        </div>
                    `;
                }

                // â–¼â–¼â–¼ æ³¨æ„é€™è£¡ï¼šHTML çµæ§‹å·²ç¶“åŠ å…¥ img æ¨™ç±¤ â–¼â–¼â–¼
                card.innerHTML = `
                    <button onclick="controlTimer(${timer.id}, 'delete')" class="absolute top-4 right-4 ${timer.type === 'night_cycle' && timer.isNight ? 'text-slate-600 hover:text-white' : 'text-gray-300 hover:text-red-400'} transition-colors">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>

                    <div class="flex flex-col items-center gap-2 mt-1">
                        <img src="${imageUrl}" alt="${timer.name}" class="w-16 h-16 object-contain rounded-full bg-white/30 p-1 shadow-sm border border-white/20">
                        <h3 class="text-lg font-bold text-center leading-tight">${timer.name}</h3>
                    </div>
                    
                    <div class="relative w-40 h-40 flex items-center justify-center">
                        <svg class="w-full h-full" viewBox="0 0 128 128">
                            <circle class="${timer.type==='night_cycle' && timer.isNight ? 'text-slate-700' : 'text-gray-100'}" stroke-width="8" stroke="currentColor" fill="transparent" r="56" cx="64" cy="64"/>
                            <circle class="${strokeColor} progress-ring__circle transition-all duration-500" 
                                stroke-width="8" stroke-dasharray="${circumference}" stroke-dashoffset="${dashoffset}" 
                                stroke-linecap="round" stroke="currentColor" fill="transparent" r="56" cx="64" cy="64"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-4xl font-bold font-mono tracking-tighter">${mins}:${secs}</span>
                            <span class="text-xs font-semibold mt-1 opacity-70 uppercase tracking-wide">${statusText}</span>
                        </div>
                    </div>
                    ${controlsHtml}
                `;
                container.appendChild(card);
            });
        }
        init();
    </script>
</body>
</html>




